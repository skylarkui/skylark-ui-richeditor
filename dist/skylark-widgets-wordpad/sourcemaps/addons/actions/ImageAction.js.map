{"version":3,"sources":["addons/actions/ImageAction.js"],"names":["define","langx","$","selectFile","readImage","addons","Action","ImagePopover","i18n","ImageAction","inherit","name","icon","htmlTag","disableTag","placeholderImage","needFocus","_init","item","k","len","ref","_this","prototype","call","this","editor","options","imageAction","Array","isArray","menu","length","push","text","_t","uploader","translate","param","actions","image","body","on","e","$img","range","currentTarget","document","createRange","selectNode","editable","selection","util","support","onselectionchange","trigger","$contents","cloneContents","contents","is","startContainer","eq","startOffset","popover","action","show","hide","$masks","wrapper","find","each","i","mask","$mask","file","data","parent","remove","cancel","upload","_initUploader","$uploadItem","inline","img","createImage","addClass","obj","then","src","hasClass","loadImage","active","refresh","srcEl","val","prop","uploadProgress","proxy","throttle","loaded","total","percent","toFixed","height","result","img_path","JSON","parse","uploadedImagePath","files","url","_error","success","removeData","removeClass","xhr","statusText","responseText","msg","_status","_disableStatus","callback","positionMask","imgOffset","wrapperOffset","offset","css","top","left","width","appendTo","Image","onload","attr","data-image-size","reflow","isFunction","onerror","inputManager","focused","focus","deleteContents","insertNode","setRangeAfter","_execute","menuItem","self","click","one","select","title","multiple","accept","picked"],"mappings":"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","file":"../../../addons/actions/ImageAction.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-domx-query\",\r\n  \"skylark-io-diskfs/select\",\r\n  \"skylark-io-diskfs/readImage\",  \r\n  \"../../addons\",\r\n  \"../../Action\",\r\n  \"./ImagePopover\",\r\n  \"../../i18n\"\r\n],function(langx, $, selectFile,readImage, addons,Action,ImagePopover,i18n){ \r\n   var ImageAction = Action.inherit({\r\n      name : 'image',\r\n\r\n      icon : 'image',\r\n\r\n      htmlTag : 'img',\r\n\r\n      disableTag : 'pre, table',\r\n\r\n      placeholderImage : '',\r\n\r\n      needFocus : false,\r\n\r\n      _init : function() {\r\n        Action.prototype._init.call(this);\r\n\r\n        var item, k, len, ref;\r\n        if (this.editor.options.imageAction) {\r\n          if (Array.isArray(this.editor.options.imageAction)) {\r\n            this.menu = [];\r\n            ref = this.editor.options.imageAction;\r\n            for (k = 0, len = ref.length; k < len; k++) {\r\n              item = ref[k];\r\n              this.menu.push({\r\n                name: item + '-image',\r\n                text: this._t(item + 'Image')\r\n              });\r\n            }\r\n          } else {\r\n            this.menu = false;\r\n          }\r\n        } else {\r\n          if (this.editor.uploader != null) {\r\n            this.menu = [\r\n              {\r\n                name: 'upload-image',\r\n                text: i18n.translate('uploadImage'),\r\n                param: 'uploadImage'\r\n              }, {\r\n                name: 'external-image',\r\n                text: i18n.translate('externalImage'),\r\n                param : 'externalImage'\r\n              }\r\n            ];\r\n          } else {\r\n            this.menu = false;\r\n          }\r\n        }\r\n        this.placeholderImage = this.editor.options.addons.actions.image.placeholderImage;\r\n        this.editor.body.on('click', 'img:not([data-non-image])', (function(_this) {\r\n          return function(e) {\r\n            var $img, range;\r\n            $img = $(e.currentTarget);\r\n            range = document.createRange();\r\n            range.selectNode($img[0]);\r\n            _this.editor.editable.selection.range(range);\r\n            if (!_this.editor.editable.util.support.onselectionchange) {\r\n              _this.editor.trigger('selectionchanged');\r\n            }\r\n            return false;\r\n          };\r\n        })(this));\r\n        this.editor.body.on('mouseup', 'img:not([data-non-image])', function(e) {\r\n          return false;\r\n        });\r\n        this.editor.on('selectionchanged.image', (function(_this) {\r\n          return function() {\r\n            var $contents, $img, range;\r\n            range = _this.editor.editable.selection.range();\r\n            if (range == null) {\r\n              return;\r\n            }\r\n            $contents = $(range.cloneContents()).contents();\r\n            if ($contents.length === 1 && $contents.is('img:not([data-non-image])')) {\r\n              $img = $(range.startContainer).contents().eq(range.startOffset);\r\n              if (!_this.popover) {\r\n                _this.popover = new ImagePopover({\r\n                  action: _this\r\n                });                \r\n              }\r\n\r\n              return _this.popover.show($img);\r\n            } else {\r\n              if (_this.popover) {\r\n                  return _this.popover.hide();\r\n              }\r\n            }\r\n          };\r\n        })(this));\r\n        this.editor.on('valuechanged.image', (function(_this) {\r\n          return function() {\r\n            var $masks;\r\n            $masks = _this.editor.wrapper.find('.wordpad-image-loading');\r\n            if (!($masks.length > 0)) {\r\n              return;\r\n            }\r\n            return $masks.each(function(i, mask) {\r\n              var $img, $mask, file;\r\n              $mask = $(mask);\r\n              $img = $mask.data('img');\r\n              if (!($img && $img.parent().length > 0)) {\r\n                $mask.remove();\r\n                if ($img) {\r\n                  file = $img.data('file');\r\n                  if (file) {\r\n                    _this.editor.uploader.cancel(file);\r\n                    if (_this.editor.body.find('img.uploading').length < 1) {\r\n                      return _this.editor.uploader.trigger('uploadready', [file]);\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            });\r\n          };\r\n        })(this));\r\n\r\n        this.popover = new ImagePopover({\r\n          action: this\r\n        });\r\n\r\n        if (this.editor.options.upload) {\r\n          return this._initUploader();\r\n        }\r\n\r\n\r\n      },\r\n\r\n      _initUploader : function($uploadItem) {\r\n\r\n        this.editor.uploader.on('beforeupload', (function(_this) {\r\n          return function(e, file) {\r\n            var $img;\r\n            if (!file.inline) {\r\n              return;\r\n            }\r\n            if (file.img) {\r\n              $img = $(file.img);\r\n            } else {\r\n              $img = _this.createImage(file.name);\r\n              file.img = $img;\r\n            }\r\n            $img.addClass('uploading');\r\n            $img.data('file', file);\r\n            return readImage(file.obj).then(function(img) {\r\n              var src;\r\n              if (!$img.hasClass('uploading')) {\r\n                return;\r\n              }\r\n              src = img ? img.src : _this.placeholderImage;\r\n              return _this.loadImage($img, src, function() {\r\n                if (_this.popover.active) {\r\n                  _this.popover.refresh();\r\n                  return _this.popover.srcEl.val(_this._t('uploading')).prop('disabled', true);\r\n                }\r\n              });\r\n            });\r\n          };\r\n        })(this));\r\n        uploadProgress = langx.proxy(this.editor.editable.util.throttle(function(e, file, loaded, total) {\r\n          var $img, $mask, percent;\r\n          if (!file.inline) {\r\n            return;\r\n          }\r\n          $mask = file.img.data('mask');\r\n          if (!$mask) {\r\n            return;\r\n          }\r\n          $img = $mask.data('img');\r\n          if (!($img.hasClass('uploading') && $img.parent().length > 0)) {\r\n            $mask.remove();\r\n            return;\r\n          }\r\n          percent = loaded / total;\r\n          percent = (percent * 100).toFixed(0);\r\n          if (percent > 99) {\r\n            percent = 99;\r\n          }\r\n          return $mask.find('.progress').height((100 - percent) + \"%\");\r\n        }, 500), this);\r\n        this.editor.uploader.on('uploadprogress', uploadProgress);\r\n        this.editor.uploader.on('uploadsuccess', (function(_this) {\r\n          return function(e, file, result) {\r\n            var $img, img_path, msg;\r\n            if (!file.inline) {\r\n              return;\r\n            }\r\n            $img = file.img;\r\n            if (!($img.hasClass('uploading') && $img.parent().length > 0)) {\r\n              return;\r\n            }\r\n            try {\r\n                if (typeof result !== 'object') {\r\n                   result = JSON.parse(result);\r\n                }\r\n                if (_this.editor.options.upload.uploadedImagePath) {\r\n                \timg_path = _this.editor.options.upload.uploadedImagePath(result);\r\n                } else {\r\n\t                img_path = result.files[0].url;\r\n                }\r\n            } catch (_error) {\r\n                e = _error;\r\n                result = {\r\n                  success: false\r\n                };\r\n            }\r\n\r\n            _this.loadImage($img, img_path, function() {\r\n              var $mask;\r\n              $img.removeData('file');\r\n              $img.removeClass('uploading').removeClass('loading');\r\n              $mask = $img.data('mask');\r\n              if ($mask) {\r\n                $mask.remove();\r\n              }\r\n              $img.removeData('mask');\r\n              _this.editor.trigger('valuechanged');\r\n              if (_this.editor.body.find('img.uploading').length < 1) {\r\n                return _this.editor.uploader.trigger('uploadready', [file, result]);\r\n              }\r\n            });\r\n            if (_this.popover.active) {\r\n              _this.popover.srcEl.prop('disabled', false);\r\n              return _this.popover.srcEl.val(img_path);\r\n            }\r\n          };\r\n        })(this));\r\n        return this.editor.uploader.on('uploaderror', (function(_this) {\r\n          return function(e, file, xhr) {\r\n            var $img, msg, result;\r\n            if (!file.inline) {\r\n              return;\r\n            }\r\n            if (xhr.statusText === 'abort') {\r\n              return;\r\n            }\r\n            if (xhr.responseText) {\r\n              try {\r\n                result = JSON.parse(xhr.responseText);\r\n                msg = result.msg;\r\n              } catch (_error) {\r\n                e = _error;\r\n                msg = _this._t('uploadError');\r\n              }\r\n            }\r\n            $img = file.img;\r\n            if (!($img.hasClass('uploading') && $img.parent().length > 0)) {\r\n              return;\r\n            }\r\n            _this.loadImage($img, _this.placeholderImage, function() {\r\n              var $mask;\r\n              $img.removeData('file');\r\n              $img.removeClass('uploading').removeClass('loading');\r\n              $mask = $img.data('mask');\r\n              if ($mask) {\r\n                $mask.remove();\r\n              }\r\n              return $img.removeData('mask');\r\n            });\r\n            if (_this.popover.active) {\r\n              _this.popover.srcEl.prop('disabled', false);\r\n              _this.popover.srcEl.val(_this.placeholderImage);\r\n            }\r\n            _this.editor.trigger('valuechanged');\r\n            if (_this.editor.body.find('img.uploading').length < 1) {\r\n              return _this.editor.uploader.trigger('uploadready', [file, result]);\r\n            }\r\n          };\r\n        })(this));\r\n      },\r\n\r\n      _status : function() {\r\n        return this._disableStatus();\r\n      },\r\n\r\n      loadImage : function($img, src, callback) {\r\n        var $mask, img, positionMask;\r\n        positionMask = (function(_this) {\r\n          return function() {\r\n            var imgOffset, wrapperOffset;\r\n            imgOffset = $img.offset();\r\n            wrapperOffset = _this.editor.wrapper.offset();\r\n            return $mask.css({\r\n              top: imgOffset.top - wrapperOffset.top,\r\n              left: imgOffset.left - wrapperOffset.left,\r\n              width: $img.width(),\r\n              height: $img.height()\r\n            }).show();\r\n          };\r\n        })(this);\r\n        $img.addClass('loading');\r\n        $mask = $img.data('mask');\r\n        if (!$mask) {\r\n          $mask = $('<div class=\"wordpad-image-loading\">\\n  <div class=\"progress\"></div>\\n</div>').hide().appendTo(this.editor.wrapper);\r\n          positionMask();\r\n          $img.data('mask', $mask);\r\n          $mask.data('img', $img);\r\n        }\r\n        img = new Image();\r\n        img.onload = (function(_this) {\r\n          return function() {\r\n            var height, width;\r\n            if (!$img.hasClass('loading') && !$img.hasClass('uploading')) {\r\n              return;\r\n            }\r\n            width = img.width;\r\n            height = img.height;\r\n            $img.attr({\r\n              src: src,\r\n              width: width,\r\n              height: height,\r\n              'data-image-size': width + ',' + height\r\n            }).removeClass('loading');\r\n            if ($img.hasClass('uploading')) {\r\n              _this.editor.editable.util.reflow(_this.editor.body);\r\n              positionMask();\r\n            } else {\r\n              $mask.remove();\r\n              $img.removeData('mask');\r\n            }\r\n            _this.editor.trigger('valuechanged');\r\n            if (langx.isFunction(callback)) {\r\n              return callback(img);\r\n            }\r\n          };\r\n        })(this);\r\n        img.onerror = function() {\r\n          if (langx.isFunction(callback)) {\r\n            callback(false);\r\n          }\r\n          $mask.remove();\r\n          return $img.removeData('mask').removeClass('loading');\r\n        };\r\n        return img.src = src;\r\n      },\r\n\r\n      createImage : function(name) {\r\n        var $img, range;\r\n        if (name == null) {\r\n          name = 'Image';\r\n        }\r\n        if (!this.editor.editable.inputManager.focused) {\r\n          this.editor.focus();\r\n        }\r\n        range = this.editor.editable.selection.range();\r\n        range.deleteContents();\r\n        this.editor.editable.selection.range(range);\r\n        $img = $('<img/>').attr('alt', name);\r\n        range.insertNode($img[0]);\r\n        this.editor.editable.selection.setRangeAfter($img, range);\r\n        this.editor.trigger('valuechanged');\r\n        return $img;\r\n      },\r\n\r\n      _execute : function(menuItem) {\r\n        var self = this;\r\n        if (menuItem==\"uploadImage\") {\r\n          selectFile({\r\n            title: this._t('uploadImage'),\r\n            multiple: true,\r\n            accept: 'image/gif,image/jpeg,image/jpg,image/png,image/svg',\r\n            picked : function(files){\r\n              self.editor.uploader.upload(files, {\r\n                inline: true,\r\n//                img: $img\r\n              });\r\n            }      \r\n\r\n          });\r\n        } else {\r\n          var $img = this.createImage();\r\n          return this.loadImage($img, this.placeholderImage, (function(_this) {\r\n            return function() {\r\n              _this.editor.trigger('valuechanged');\r\n              _this.editor.editable.util.reflow($img);\r\n              $img.click();\r\n              return _this.popover.one('popovershow', function() {\r\n                _this.popover.srcEl.focus();\r\n                return _this.popover.srcEl[0].select();\r\n              });\r\n            };\r\n          })(this));\r\n\r\n        }\r\n      }\r\n\r\n   });\r\n\r\n   addons.actions.image = ImageAction; \r\n\r\n   return ImageAction;\r\n\r\n});"]}