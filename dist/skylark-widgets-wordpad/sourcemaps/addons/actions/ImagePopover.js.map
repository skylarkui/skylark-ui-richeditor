{"version":3,"sources":["addons/actions/ImagePopover.js"],"names":["define","langx","$","addons","Popover","ImagePopover","inherit","prototype","offset","top","left","render","tpl","_this","this","_t","el","addClass","append","srcEl","find","widthEl","heightEl","altEl","on","e","range","which","target","hasClass","preventDefault","document","createRange","action","editor","editable","selection","setRangeAfter","hide","_loadImage","val","_resizeImg","currentTarget","data","refresh","inputEl","$img","_restoreImg","alt","attr","active","_initUploader","$uploadBtn","uploader","picker","title","multiple","accept","picked","files","upload","inline","img","remove","onlySetVal","height","value","width","isNumber","is","trigger","ref","size","split","src","callback","test","loadImage","blob","util","dataURLtoBlob","name","show","args","arguments","length","Array","slice","call","apply","prop"],"mappings":"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","file":"../../../addons/actions/ImagePopover.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-domx-query\",\r\n  \"../../addons\",\r\n  \"../../Popover\"\r\n],function(langx, $,addons,Popover){ \r\n   var ImagePopover = Popover.inherit({\r\n\r\n   });\r\n\r\n  ImagePopover.prototype.offset = {\r\n    top: 6,\r\n    left: -4\r\n  };\r\n\r\n  ImagePopover.prototype.render = function() {\r\n    var tpl;\r\n    tpl = \"<div class=\\\"link-settings\\\">\\n  <div class=\\\"settings-field\\\">\\n    <label>\" + (this._t('imageUrl')) + \"</label>\\n    <input class=\\\"image-src\\\" type=\\\"text\\\" tabindex=\\\"1\\\" />\\n    <a class=\\\"btn-upload\\\" href=\\\"javascript:;\\\"\\n      title=\\\"\" + (this._t('uploadImage')) + \"\\\" tabindex=\\\"-1\\\">\\n      <span class=\\\"fa fa-upload\\\"></span>\\n    </a>\\n  </div>\\n  <div class='settings-field'>\\n    <label>\" + (this._t('imageAlt')) + \"</label>\\n    <input class=\\\"image-alt\\\" id=\\\"image-alt\\\" type=\\\"text\\\" tabindex=\\\"1\\\" />\\n  </div>\\n  <div class=\\\"settings-field\\\">\\n    <label>\" + (this._t('imageSize')) + \"</label>\\n    <input class=\\\"image-size\\\" id=\\\"image-width\\\" type=\\\"text\\\" tabindex=\\\"2\\\" />\\n    <span class=\\\"times\\\">Ã—</span>\\n    <input class=\\\"image-size\\\" id=\\\"image-height\\\" type=\\\"text\\\" tabindex=\\\"3\\\" />\\n    <a class=\\\"btn-restore\\\" href=\\\"javascript:;\\\"\\n      title=\\\"\" + (this._t('restoreImageSize')) + \"\\\" tabindex=\\\"-1\\\">\\n      <span class=\\\"fa fa-undo\\\"></span>\\n    </a>\\n  </div>\\n</div>\";\r\n    this.el.addClass('image-popover').append(tpl);\r\n    this.srcEl = this.el.find('.image-src');\r\n    this.widthEl = this.el.find('#image-width');\r\n    this.heightEl = this.el.find('#image-height');\r\n    this.altEl = this.el.find('#image-alt');\r\n    this.srcEl.on('keydown', (function(_this) {\r\n      return function(e) {\r\n        var range;\r\n        if (!(e.which === 13 && !_this.target.hasClass('uploading'))) {\r\n          return;\r\n        }\r\n        e.preventDefault();\r\n        range = document.createRange();\r\n        _this.action.editor.editable.selection.setRangeAfter(_this.target, range);\r\n        return _this.hide();\r\n      };\r\n    })(this));\r\n    this.srcEl.on('blur', (function(_this) {\r\n      return function(e) {\r\n        return _this._loadImage(_this.srcEl.val());\r\n      };\r\n    })(this));\r\n    this.el.find('.image-size').on('blur', (function(_this) {\r\n      return function(e) {\r\n        _this._resizeImg($(e.currentTarget));\r\n        return _this.el.data('popover').refresh();\r\n      };\r\n    })(this));\r\n    this.el.find('.image-size').on('keyup', (function(_this) {\r\n      return function(e) {\r\n        var inputEl;\r\n        inputEl = $(e.currentTarget);\r\n        if (!(e.which === 13 || e.which === 27 || e.which === 9)) {\r\n          return _this._resizeImg(inputEl, true);\r\n        }\r\n      };\r\n    })(this));\r\n    this.el.find('.image-size').on('keydown', (function(_this) {\r\n      return function(e) {\r\n        var $img, inputEl, range;\r\n        inputEl = $(e.currentTarget);\r\n        if (e.which === 13 || e.which === 27) {\r\n          e.preventDefault();\r\n          if (e.which === 13) {\r\n            _this._resizeImg(inputEl);\r\n          } else {\r\n            _this._restoreImg();\r\n          }\r\n          $img = _this.target;\r\n          _this.hide();\r\n          range = document.createRange();\r\n          return _this.action.editor.editable.selection.setRangeAfter($img, range);\r\n        } else if (e.which === 9) {\r\n          return _this.el.data('popover').refresh();\r\n        }\r\n      };\r\n    })(this));\r\n    this.altEl.on('keydown', (function(_this) {\r\n      return function(e) {\r\n        var range;\r\n        if (e.which === 13) {\r\n          e.preventDefault();\r\n          range = document.createRange();\r\n          _this.action.editor.editable.selection.setRangeAfter(_this.target, range);\r\n          return _this.hide();\r\n        }\r\n      };\r\n    })(this));\r\n    this.altEl.on('keyup', (function(_this) {\r\n      return function(e) {\r\n        if (e.which === 13 || e.which === 27 || e.which === 9) {\r\n          return;\r\n        }\r\n        _this.alt = _this.altEl.val();\r\n        return _this.target.attr('alt', _this.alt);\r\n      };\r\n    })(this));\r\n    this.el.find('.btn-restore').on('click', (function(_this) {\r\n      return function(e) {\r\n        _this._restoreImg();\r\n        return _this.el.data('popover').refresh();\r\n      };\r\n    })(this));\r\n    this.editor.on('valuechanged', (function(_this) {\r\n      return function(e) {\r\n        if (_this.active) {\r\n          return _this.refresh();\r\n        }\r\n      };\r\n    })(this));\r\n    return this._initUploader();\r\n  };\r\n\r\n  ImagePopover.prototype._initUploader = function() {\r\n    var $uploadBtn, createInput;\r\n    $uploadBtn = this.el.find('.btn-upload');\r\n    if (this.editor.uploader == null) {\r\n      $uploadBtn.remove();\r\n      return;\r\n    }\r\n\r\n    var _this = this;\r\n    $uploadBtn.picker({\r\n      title: _this._t('uploadImage'),\r\n      multiple: true,\r\n      accept: 'image/gif,image/jpeg,image/jpg,image/png,image/svg',\r\n      picked : function(files){\r\n        _this.editor.uploader.upload(files, {\r\n          inline: true,\r\n          img: _this.target\r\n        });\r\n      }      \r\n\r\n    });\r\n  };\r\n\r\n  ImagePopover.prototype._resizeImg = function(inputEl, onlySetVal) {\r\n    var height, value, width;\r\n    if (onlySetVal == null) {\r\n      onlySetVal = false;\r\n    }\r\n    value = inputEl.val() * 1;\r\n    if (!(this.target && (langx.isNumber(value) || value < 0))) {\r\n      return;\r\n    }\r\n    if (inputEl.is(this.widthEl)) {\r\n      width = value;\r\n      height = this.height * value / this.width;\r\n      this.heightEl.val(height);\r\n    } else {\r\n      height = value;\r\n      width = this.width * value / this.height;\r\n      this.widthEl.val(width);\r\n    }\r\n    if (!onlySetVal) {\r\n      this.target.attr({\r\n        width: width,\r\n        height: height\r\n      });\r\n      return this.editor.trigger('valuechanged');\r\n    }\r\n  };\r\n\r\n  ImagePopover.prototype._restoreImg = function() {\r\n    var ref, size;\r\n    size = ((ref = this.target.data('image-size')) != null ? ref.split(\",\") : void 0) || [this.width, this.height];\r\n    this.target.attr({\r\n      width: size[0] * 1,\r\n      height: size[1] * 1\r\n    });\r\n    this.widthEl.val(size[0]);\r\n    this.heightEl.val(size[1]);\r\n    return this.editor.trigger('valuechanged');\r\n  };\r\n\r\n  ImagePopover.prototype._loadImage = function(src, callback) {\r\n    if (/^data:image/.test(src) && !this.editor.uploader) {\r\n      if (callback) {\r\n        callback(false);\r\n      }\r\n      return;\r\n    }\r\n    if (this.target.attr('src') === src) {\r\n      return;\r\n    }\r\n    return this.action.loadImage(this.target, src, (function(_this) {\r\n      return function(img) {\r\n        var blob;\r\n        if (!img) {\r\n          return;\r\n        }\r\n        if (_this.active) {\r\n          _this.width = img.width;\r\n          _this.height = img.height;\r\n          _this.widthEl.val(_this.width);\r\n          _this.heightEl.val(_this.height);\r\n        }\r\n        if (/^data:image/.test(src)) {\r\n          blob = _this.editor.editable.util.dataURLtoBlob(src);\r\n          blob.name = \"Base64 Image.png\";\r\n          _this.editor.uploader.upload(blob, {\r\n            inline: true,\r\n            img: _this.target\r\n          });\r\n        } else {\r\n          _this.editor.trigger('valuechanged');\r\n        }\r\n        if (callback) {\r\n          return callback(img);\r\n        }\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  ImagePopover.prototype.show = function() {\r\n    var $img, args;\r\n    args = 1 <= arguments.length ? Array.prototype.slice.call(arguments, 0) : [];\r\n    Popover.prototype.show.apply(this, args);\r\n    $img = this.target;\r\n    this.width = $img.width();\r\n    this.height = $img.height();\r\n    this.alt = $img.attr('alt');\r\n    if ($img.hasClass('uploading')) {\r\n      return this.srcEl.val(this._t('uploading')).prop('disabled', true);\r\n    } else {\r\n      this.srcEl.val($img.attr('src')).prop('disabled', false);\r\n      this.widthEl.val(this.width);\r\n      this.heightEl.val(this.height);\r\n      return this.altEl.val(this.alt);\r\n    }\r\n  };\r\n\r\n  return ImagePopover;\r\n\r\n});"]}